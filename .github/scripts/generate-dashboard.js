const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');

// Load configuration
const config = yaml.load(fs.readFileSync('config/dashboard-config.yml', 'utf8'));

// Paths
const REPORTS_DIR = 'reports';
const ANALYSIS_DIR = 'analysis';
const WEBSITE_DIR = 'website';

// Ensure website directory exists
if (!fs.existsSync(WEBSITE_DIR)) {
  fs.mkdirSync(WEBSITE_DIR, { recursive: true });
}

// Discover all projects from reports directory
function discoverProjects() {
  if (!fs.existsSync(REPORTS_DIR)) {
    console.log('No reports directory found');
    return [];
  }

  return fs.readdirSync(REPORTS_DIR)
    .filter(name => fs.statSync(path.join(REPORTS_DIR, name)).isDirectory())
    .map(name => ({
      id: name,
      name: config.projects?.[name]?.display_name || name,
      color: config.projects?.[name]?.color || '#667eea'
    }));
}

// Get all reports for a project
function getProjectReports(projectId) {
  const projectDir = path.join(REPORTS_DIR, projectId);
  if (!fs.existsSync(projectDir)) return [];

  return fs.readdirSync(projectDir)
    .filter(name => fs.statSync(path.join(projectDir, name)).isDirectory())
    .map(timestamp => {
      const metadataPath = path.join(projectDir, timestamp, 'metadata.json');
      let metadata = {
        project: projectId,
        timestamp,
        status: 'unknown',
        total_tests: 0,
        passed: 0,
        failed: 0,
        pass_rate: 0
      };

      if (fs.existsSync(metadataPath)) {
        try {
          const data = JSON.parse(fs.readFileSync(metadataPath, 'utf8'));
          metadata = { ...metadata, ...data };
        } catch (e) {
          console.warn(`Failed to parse metadata for ${projectId}/${timestamp}`);
        }
      }

      return metadata;
    })
    .sort((a, b) => b.timestamp.localeCompare(a.timestamp)); // Sort by timestamp desc
}

// Get latest AI analysis for a project
function getLatestAnalysis(projectId) {
  const analysisPath = path.join(ANALYSIS_DIR, projectId, 'latest-analysis.md');
  if (fs.existsSync(analysisPath)) {
    const content = fs.readFileSync(analysisPath, 'utf8');
    // Extract summary (first paragraph after first heading)
    const match = content.match(/^##?\s+[^\n]+\n\n([^\n]+)/m);
    return match ? match[1] : 'Analysis available';
  }
  return null;
}

// Calculate statistics for a project
function calculateProjectStats(reports) {
  if (reports.length === 0) {
    return {
      latest: null,
      passRate: 0,
      trend: 0,
      totalRuns: 0
    };
  }

  const latest = reports[0];
  const passRate = latest.pass_rate || 0;

  // Calculate trend (compare with previous run)
  let trend = 0;
  if (reports.length > 1) {
    const previous = reports[1];
    const previousRate = previous.pass_rate || 0;
    trend = passRate - previousRate;
  }

  return {
    latest,
    passRate,
    trend,
    totalRuns: reports.length
  };
}

// Generate HTML header
function generateHeader(title) {
  return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title} - QA Test Reports</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div class="container">
    <header class="site-header">
      <h1>${title}</h1>
      <nav>
        <a href="index.html">Dashboard</a>
        <a href="timeline.html">Timeline</a>
      </nav>
    </header>
`;
}

// Generate HTML footer
function generateFooter() {
  const now = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
  return `
    <footer class="site-footer">
      <p>Generated by GitHub Actions | Last updated: ${now}</p>
    </footer>
  </div>
</body>
</html>
`;
}

// Generate project card
function generateProjectCard(project, stats) {
  const { latest, passRate, trend, totalRuns } = stats;

  if (!latest) {
    return `
      <div class="project-card no-data">
        <h3>${project.name}</h3>
        <p class="status">No test data available</p>
      </div>
    `;
  }

  const statusClass = passRate >= 95 ? 'passing' : passRate >= 80 ? 'warning' : 'failed';
  const statusEmoji = passRate >= 95 ? '‚úÖ' : passRate >= 80 ? 'üü°' : '‚ùå';
  const trendEmoji = trend > 0 ? '‚Üó' : trend < 0 ? '‚Üò' : '‚Üí';

  const aiInsight = getLatestAnalysis(project.id);
  const timeAgo = formatTimeAgo(latest.timestamp);

  return `
    <div class="project-card ${statusClass}">
      <div class="card-header">
        <h3>${project.name}</h3>
        <span class="status-badge">${statusEmoji} ${statusClass.toUpperCase()}</span>
      </div>

      <div class="card-body">
        <div class="metric">
          <span class="metric-value">${passRate.toFixed(1)}%</span>
          <span class="metric-label">${latest.passed}/${latest.total_tests} tests</span>
        </div>

        <div class="info">
          <p>Latest: ${timeAgo}</p>
          <p>Trend: ${trendEmoji} ${trend > 0 ? '+' : ''}${trend.toFixed(1)}%</p>
        </div>

        ${aiInsight ? `
        <div class="ai-insight">
          <strong>AI Insights:</strong>
          <p>${aiInsight}</p>
        </div>
        ` : ''}
      </div>

      <div class="card-footer">
        <a href="projects/${project.id}.html" class="btn">View Details</a>
        <a href="projects/${project.id}.html#history" class="btn btn-secondary">History (${totalRuns})</a>
      </div>
    </div>
  `;
}

// Format timestamp to human-readable "time ago"
function formatTimeAgo(timestamp) {
  // timestamp format: 20260208-143020
  const year = timestamp.substr(0, 4);
  const month = timestamp.substr(4, 2);
  const day = timestamp.substr(6, 2);
  const hour = timestamp.substr(9, 2);
  const minute = timestamp.substr(11, 2);

  const date = new Date(`${year}-${month}-${day}T${hour}:${minute}:00Z`);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return `${Math.floor(diffDays / 7)}w ago`;
}

// Generate main dashboard
function generateDashboard(projects) {
  let html = generateHeader('QA Test Reports Dashboard');

  html += '<main class="dashboard">\n';
  html += '<div class="projects-grid">\n';

  projects.forEach(project => {
    const reports = getProjectReports(project.id);
    const stats = calculateProjectStats(reports);
    html += generateProjectCard(project, stats);
  });

  html += '</div>\n</main>\n';
  html += generateFooter();

  fs.writeFileSync(path.join(WEBSITE_DIR, 'index.html'), html);
  console.log('‚úì Generated dashboard');
}

// Generate timeline view
function generateTimeline(projects) {
  let html = generateHeader('Test Timeline');

  // Collect all reports from all projects
  const allReports = [];
  projects.forEach(project => {
    const reports = getProjectReports(project.id);
    reports.forEach(report => {
      allReports.push({ ...report, projectName: project.name, projectId: project.id });
    });
  });

  // Sort by timestamp desc
  allReports.sort((a, b) => b.timestamp.localeCompare(a.timestamp));

  // Group by date
  const grouped = {};
  allReports.forEach(report => {
    const date = report.timestamp.substr(0, 8); // YYYYMMDD
    if (!grouped[date]) grouped[date] = [];
    grouped[date].push(report);
  });

  html += '<main class="timeline">\n';

  Object.keys(grouped).sort().reverse().forEach(date => {
    const formattedDate = formatDate(date);
    html += `<div class="timeline-day">\n`;
    html += `<h2>${formattedDate}</h2>\n`;

    grouped[date].forEach(report => {
      const statusEmoji = report.pass_rate >= 95 ? '‚úÖ' : report.pass_rate >= 80 ? 'üü°' : '‚ùå';
      const time = report.timestamp.substr(9, 2) + ':' + report.timestamp.substr(11, 2);

      html += `
        <div class="timeline-item">
          <span class="time">${time}</span>
          <span class="project">${report.projectName}</span>
          <span class="status">${statusEmoji} Run #${report.run_number || '?'}</span>
          <span class="pass-rate">${report.pass_rate.toFixed(1)}%</span>
          <a href="projects/${report.projectId}.html#${report.timestamp}">View</a>
        </div>
      `;
    });

    html += '</div>\n';
  });

  html += '</main>\n';
  html += generateFooter();

  fs.writeFileSync(path.join(WEBSITE_DIR, 'timeline.html'), html);
  console.log('‚úì Generated timeline');
}

// Format date YYYYMMDD to readable format
function formatDate(dateStr) {
  const year = dateStr.substr(0, 4);
  const month = dateStr.substr(4, 2);
  const day = dateStr.substr(6, 2);
  const date = new Date(`${year}-${month}-${day}`);

  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);

  if (date.toDateString() === today.toDateString()) return 'Today';
  if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';

  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

// Generate project detail page
function generateProjectPage(project) {
  const reports = getProjectReports(project.id);
  const stats = calculateProjectStats(reports);

  let html = generateHeader(project.name);

  html += '<main class="project-detail">\n';

  // Overview section
  html += `
    <section class="overview">
      <h2>Overview</h2>
      <div class="stats-grid">
        <div class="stat">
          <div class="stat-value">${stats.passRate.toFixed(1)}%</div>
          <div class="stat-label">Current Pass Rate</div>
        </div>
        <div class="stat">
          <div class="stat-value">${stats.totalRuns}</div>
          <div class="stat-label">Total Runs</div>
        </div>
        <div class="stat">
          <div class="stat-value">${stats.trend > 0 ? '+' : ''}${stats.trend.toFixed(1)}%</div>
          <div class="stat-label">Trend</div>
        </div>
      </div>
    </section>
  `;

  // AI Analysis section
  const trendAnalysisPath = path.join(ANALYSIS_DIR, project.id, 'trend-analysis.md');
  if (fs.existsSync(trendAnalysisPath)) {
    const trendAnalysis = fs.readFileSync(trendAnalysisPath, 'utf8');
    html += `
      <section class="ai-analysis">
        <h2>AI Trend Analysis</h2>
        <div class="markdown-content">
          ${trendAnalysis.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
        </div>
      </section>
    `;
  }

  // History section
  html += `
    <section class="history" id="history">
      <h2>Test History</h2>
      <table class="history-table">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Run #</th>
            <th>Branch</th>
            <th>Status</th>
            <th>Pass Rate</th>
            <th>Tests</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
  `;

  reports.forEach(report => {
    const statusEmoji = report.pass_rate >= 95 ? '‚úÖ' : report.pass_rate >= 80 ? 'üü°' : '‚ùå';
    const timestamp = formatTimestamp(report.timestamp);

    html += `
      <tr id="${report.timestamp}">
        <td>${timestamp}</td>
        <td>#${report.run_number || '?'}</td>
        <td>${report.branch || 'N/A'}</td>
        <td>${statusEmoji} ${report.status}</td>
        <td>${report.pass_rate.toFixed(1)}%</td>
        <td>${report.passed}/${report.total_tests}</td>
        <td>
          <a href="../reports/${project.id}/${report.timestamp}/report.html" target="_blank">View</a>
        </td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </section>
  `;

  html += '</main>\n';
  html += generateFooter();

  // Ensure projects directory exists
  const projectsDir = path.join(WEBSITE_DIR, 'projects');
  if (!fs.existsSync(projectsDir)) {
    fs.mkdirSync(projectsDir, { recursive: true });
  }

  fs.writeFileSync(path.join(projectsDir, `${project.id}.html`), html);
  console.log(`‚úì Generated project page: ${project.id}`);
}

// Format timestamp for display
function formatTimestamp(timestamp) {
  const year = timestamp.substr(0, 4);
  const month = timestamp.substr(4, 2);
  const day = timestamp.substr(6, 2);
  const hour = timestamp.substr(9, 2);
  const minute = timestamp.substr(11, 2);

  return `${year}-${month}-${day} ${hour}:${minute}`;
}

// Copy CSS file
function generateCSS() {
  const css = `
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  line-height: 1.6;
  color: #333;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.site-header {
  text-align: center;
  color: white;
  padding: 40px 0;
  margin-bottom: 40px;
}

.site-header h1 {
  font-size: 3rem;
  margin-bottom: 20px;
  text-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.site-header nav {
  margin-top: 20px;
}

.site-header nav a {
  color: white;
  text-decoration: none;
  margin: 0 15px;
  padding: 10px 20px;
  background: rgba(255,255,255,0.2);
  border-radius: 8px;
  transition: background 0.3s;
}

.site-header nav a:hover {
  background: rgba(255,255,255,0.3);
}

.projects-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 30px;
  margin-bottom: 50px;
}

.project-card {
  background: white;
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  transition: transform 0.3s, box-shadow 0.3s;
}

.project-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.card-header h3 {
  font-size: 1.5rem;
  color: #1a1a1a;
}

.status-badge {
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
}

.passing .status-badge {
  background: #d4edda;
  color: #155724;
}

.warning .status-badge {
  background: #fff3cd;
  color: #856404;
}

.failed .status-badge {
  background: #f8d7da;
  color: #721c24;
}

.metric {
  margin-bottom: 15px;
}

.metric-value {
  font-size: 2.5rem;
  font-weight: 700;
  color: #667eea;
  display: block;
}

.metric-label {
  color: #666;
  font-size: 0.9rem;
}

.info p {
  margin: 5px 0;
  color: #666;
  font-size: 0.9rem;
}

.ai-insight {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-top: 15px;
  border-left: 4px solid #667eea;
}

.ai-insight strong {
  display: block;
  margin-bottom: 8px;
  color: #667eea;
}

.ai-insight p {
  font-size: 0.9rem;
  color: #555;
  line-height: 1.5;
}

.card-footer {
  margin-top: 20px;
  display: flex;
  gap: 10px;
}

.btn {
  padding: 10px 18px;
  background: #667eea;
  color: white;
  text-decoration: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.9rem;
  transition: background 0.3s;
  text-align: center;
  flex: 1;
}

.btn:hover {
  background: #5a6fd8;
}

.btn-secondary {
  background: #6c757d;
}

.btn-secondary:hover {
  background: #5a6268;
}

.timeline {
  background: white;
  border-radius: 16px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.timeline-day {
  margin-bottom: 30px;
}

.timeline-day h2 {
  font-size: 1.5rem;
  margin-bottom: 15px;
  color: #1a1a1a;
  border-bottom: 2px solid #667eea;
  padding-bottom: 10px;
}

.timeline-item {
  display: grid;
  grid-template-columns: 80px 200px 150px 100px auto;
  gap: 15px;
  align-items: center;
  padding: 15px;
  background: #f8f9fa;
  margin-bottom: 10px;
  border-radius: 8px;
  transition: background 0.3s;
}

.timeline-item:hover {
  background: #e9ecef;
}

.timeline-item .time {
  font-weight: 600;
  color: #667eea;
}

.timeline-item a {
  color: #667eea;
  text-decoration: none;
  font-weight: 600;
}

.project-detail {
  background: white;
  border-radius: 16px;
  padding: 40px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.project-detail section {
  margin-bottom: 40px;
}

.project-detail h2 {
  font-size: 1.8rem;
  margin-bottom: 20px;
  color: #1a1a1a;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.stat {
  text-align: center;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 12px;
}

.stat-value {
  font-size: 2.5rem;
  font-weight: 700;
  color: #667eea;
  display: block;
  margin-bottom: 8px;
}

.stat-label {
  color: #666;
  font-size: 0.9rem;
}

.history-table {
  width: 100%;
  border-collapse: collapse;
}

.history-table th,
.history-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e9ecef;
}

.history-table th {
  background: #f8f9fa;
  font-weight: 600;
  color: #1a1a1a;
}

.history-table tr:hover {
  background: #f8f9fa;
}

.markdown-content {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  white-space: pre-wrap;
  font-family: monospace;
  font-size: 0.9rem;
  line-height: 1.6;
}

.site-footer {
  text-align: center;
  color: rgba(255,255,255,0.9);
  margin-top: 50px;
  padding: 30px;
  background: rgba(255,255,255,0.1);
  border-radius: 16px;
}

.site-footer p {
  margin: 5px 0;
}

@media (max-width: 768px) {
  .site-header h1 {
    font-size: 2rem;
  }

  .projects-grid {
    grid-template-columns: 1fr;
  }

  .timeline-item {
    grid-template-columns: 1fr;
    text-align: center;
  }

  .history-table {
    font-size: 0.85rem;
  }
}
`;

  const assetsDir = path.join(WEBSITE_DIR, 'assets', 'css');
  if (!fs.existsSync(assetsDir)) {
    fs.mkdirSync(assetsDir, { recursive: true });
  }

  fs.writeFileSync(path.join(assetsDir, 'style.css'), css);
  console.log('‚úì Generated CSS');
}

// Main execution
console.log('Generating QA Reports Dashboard...\n');

const projects = discoverProjects();
console.log(`Found ${projects.length} projects: ${projects.map(p => p.id).join(', ')}\n`);

generateCSS();
generateDashboard(projects);
generateTimeline(projects);

projects.forEach(project => {
  generateProjectPage(project);
});

console.log('\nDashboard generation complete!');
